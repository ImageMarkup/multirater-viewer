<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>ISIC MultiRater Viewer</title>
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="/css/bootstrap-slider.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link href="css/jquery-ui.theme.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">
    <script src="js/multirater.js"></script>
    <script src="js/jquery-2.1.3.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/bootstrap-slider.js"></script>
    <!-- <script src="js/jquery.svg.js"></script> -->
    <script src="js/openseadragon.js"></script>
    <script src="js/openseadragon-svg-overlay.js"></script>
    <script src="js/osd-filters/osd_filters.js"></script>
    <link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
    <style>
    .vcenter {
        display: inline-block;
        vertical-align: middle;
        float: none;
    }
    
    .right-side-button {
        float: right;
        padding-right: 20px;
        margin-right: 20px;
    }
    
    .panel-heading a:after {
        font-family: 'Glyphicons Halflings';
        content: "\e114";
        float: right;
        color: grey;
    }
    
    .panel-heading a.collapsed:after {
        content: "\e080";
    }
    /* Overriding radio buttons so I can add some space and curve the borders */
    
    .feature_btns {
        /*border-top-right-radius: 4px !important;
    border-bottom-right-radius: 4px !important  ;*/
        border-radius: 4px !important;
        margin: 2px !important;
        padding: 2px !important;
    }
    
    .btn-group-single > .btn:first-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    
    .navbar-brand {
        color: yellow !important;
    }
    /*  .navbar-brand {
        position: absolute;
        width: 100%;
        left: 0;
        text-align: left;
        margin: auto;
    }*/
    
    .slider-selection {
        background: #BABABA;
    }
    
    #opacity_slider .slider-selection {
        background: #BABABA;
    }
    
    .rtr {
        padding: 10px;
        margin: 10px;
    }
    
    .featurebtns-example {
        margin: 2px !important;
        margin-bottom: 2px !important;
        padding: 2px !important;
    }
    
    .button-panel {
        margin: 2px !important;
        margin-bottom: 2px !important;
        padding: 2px !important;
    }
    
    .navbar-custom {
        color: #0000FF;
        background-color: #0000FF;
    }
    
    .inforow {
        height: 60px;
    }
    </style>



</head>

<body>
    <!-- begin template -->
    <div class="container">
        <!-- Static navbar -->
        <nav class="navbar navbar-default navbar-fixed-top  ">
            <div class="container-fluid">
                <div class="navbar-header navbar-custom" style="padding-left:5px;padding-right:5px">
                    <a class="navbar-brand" href="#" style="color:blue">ISIC MultiViewer</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li class="active"><a a href="http://isic-archive.com">Home</a></li>
                        <li><a href="#">About</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button">Dropdown <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="#">Action#1</a></li>
                                <li><a href="#">AddOtherAction</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Nav header</li>
                                <li><a href="#">Separated SOME link</a></li>
                                <li><a href="#">One more separated link</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="navbar-right ">
                        <span class="navbar-right right-side-button navbar-btn btn-sm">Overlay Opacity: <input id="opacity_slider" data-slider-id='op_slider' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.05" data-slider-value="0.5"/></span>
                        <button id="tile_toggle" class="btn btn-default navbar-right navbar-btn btn-sm ">Hide Overlays</button>
                        <button id="tile_button" class="btn  btn-default navbar-right  navbar-btn btn-sm ">Show superpixels</button>
                        <button id="show_magic" class="btn btn-default navbar-right navbar-btn btn-sm"> Filters</button>
                    </div>
                </div>
                <!--/.nav-collapse -->
            </div>
            <!--/.container-fluid -->
    </div>
    <!-- Need to cleanup class assignment for these buttons... this seems redundant -->
    </nav>
    <div class="container-fluid" id="main">
        <div class="row inforow">
            <div class="col-md-3 vcenter">
                <p class="text-center">
                    <h3>Data Set<select id="data_source_dd"></select></h3>
                </p>
            </div>
            <div class="col-md-3 vcenter">
                <p class="text-center" style="vertical-align:middle">
                    <b>Image List</b>
                    <select id='image_list_dd' style="width: 50%"></select>
                </p>
            </div>
            <div class="col-md-3 vcenter">
                <p>
                    <span id="feature_info_stats" class=""></span>
                    <span id="tile_info_stats" class=""></span>
                </p>
            </div>
            <div class="col-md-3 vcenter">
                <p class="text-center">
                    <h3>Cur Feature</h3>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4" id="left">
                <!-- <div id="slider" width="300px !important"></div> -->
                <div class="panel panel-default">
                    <div class="panel-heading" align="center">Please select the raters to overlay</div>
                    <div id="rater_info">
                        <div id="tile_opacity"></div>
                        <span id="displayed_data_info" class="h6">
                        <ul id="rater_color_list"></ul>
                        </span>
                    </div>
                </div>
                <div class="panel panel-default">
                    <!-- <div class="panel-heading" align="center"><b>Feature Selector</b></div>-->
                    <!--<div id="feature_btn_group" class="btn-group btn-group-single featurebtns_wrapper" data-toggle="buttons-radio"></div>-->
                    <!--<div id="feature_btn_group" class="featurebtns_wrapper" data-toggle="buttons-radio"></div>-->
                    <div id="feature_accordion"></div>
                </div>
                <div id="curimg_feats"></div>
                <!-- I am debating creating a second set of buttons listing what's in the current image? -->
            </div>
            <div class="col-xs-8">
                <div id="openseadragon1" style="width: 100%; height: 600px; border: 1px solid blue" class="openseadragon"></div>
            </div>
        </div>
        <!-- end template -->
        <!-- script references -->
</body>

</html>
<!-- Bootstrap -->
<script>
//Putting Various Helper functions up here
var color20 = d3.scale.category20();
var avail_studies;
var flt = {};

var colours = ['purple', 'blue', 'green  ', 'navy', 'green', 'navy', 'blue', 'pink', 'orange', 'yellow', 'lime', 'green', 'blue', 'navy', 'black'];

var color_heatmap = ['blue', 'blue', 'yellow', 'orange', 'red'];


var image_info_list = {};
var superpixel_markup_info = {}; //Stores the marked up data for each tile and rater
var active_image = '';
var current_feature = "net_typ";
var avail_studies_dict = {};
var annotated_feature_list = [];
//['net_typ', 'net_atyp', 'str_chrys','net_targ','ves_serp','ves_clods']; //will load these frim a file

//feature group should not have a space... need to think about this

var feature_groups = [{
    'feature_group': 'Structures',
    'feature_abbrev': 'str'
}, {
    'feature_group': 'Colors',
    'feature_abbrev': 'c'
}, {
    'feature_group': 'Vessels',
    'feature_abbrev': 'ves'
}, {
    'feature_group': 'Other',
    'feature_abbrev': 'oth'
}, {
    'feature_group': 'Network',
    'feature_abbrev': 'net'
}, {
    'feature_group': 'ImageSpecific',
    'feature_abbrev': 'THISSTRINGWILLNEVERMATCH'

}]

var new_geodata;
var my_data = {};
</script>
<script type="text/javascript">
// var dg_viewer = OpenSeadragon({
//     id: "openseadragon1",
//     prefixUrl: "/images/openseadragon-bin-2.0.0/images/",
//     showNavigator: true,
//     tileSources: {
//         type: 'legacy-image-pyramid',
//         levels: [{
//             url: 'images/base_img/UDA2_pilot_001-p1c.png',
//             height: 920,
//             width: 960
//         }]
//     }
// });

var dg_viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "/images/openseadragon-bin-2.0.0/images/",
    showNavigator: true,
});

svg_layer = dg_viewer.svgOverlay(); //need to move to onload handler

raters = ['braunr', 'haroldr', 'carrerac', 'marghooa'];

var OpacitySlider;

$(document).ready(function() {

    //Opacity slides which is at the top of the toolbar for  changing opacity..
    OpacitySlider = $('#opacity_slider').bootstrapSlider({
        formatter: function(value) {
            return 'Current value: ' + value;
        }
    });

    OpacitySlider.change(function(val) {
        new_slider_value = val.value.newValue;
        console.log('new slider value is' + new_slider_value)
        $(".tileClass").attr('opacity', new_slider_value);

    });
    //TODO:  Should be able to set the change function in the slider constructor.. not sure of the syntax

    //Get hte list of studies that are available
    var study_url = 'https://isic-archive.com/api/v1/study'
    study_list = $.get(study_url)

    $.getJSON(study_url, function(data) {
        avail_studies = data;
        //I am going to disable buttons on the feature list if that feature isn't present in the currnet image...
        console.log(avail_studies)
            //Also now load the feature button by iterating through them
        $.each(avail_studies, function(k, v) {
                //      console.log(v,k);
                dtoa = '<option id="' + v['_id'] + '" value="'+ v['_id'] + '">' + v.name + '</option>'
                console.log(dtoa);
                $("#data_source_dd").append(dtoa);
                avail_studies_dict[v.name] = v;
                //Need to figure out which image set to load... I guess for now I load the first one?
            })
            //Now that I have a list of all available studies, I can go ahead and populate the image list
            //This should use the function I defined above..
    });

    $("#data_source_dd").change(function(data) {

        console.log(this.value, this.id, this.option);
        //I now should actually load the images associated with this data set...
        //Now pull the image list for this data source and then update the image_list_dd
        load_new_image_set(this.value);

        console.log(avail_studies_dict[this.value]);
        //Need to now grab the url



        //var get_img_list_url = 'https://isic-archive.com/api/v1/study/' + avail_studies_dict[this.value]['_id'] + '/images/';
        var get_img_list_url = 'https://isic-archive.com/api/v1/study/' + this.value + '/images/';
        //https://isic-archive.com/api/v1/study/55c442809fc3c1536a012b57/images
        $.getJSON(get_img_list_url, function(data) {
            new_img_list = data;
            console.log(new_img_list);
            //This currently returns an _id and a name _id: "54e77f6fbae478166c01e546"  name: "ISIC_0001160"
            //TO DO:  Load the image data now??
            ///Need to remember to first clear the image list
            //Now I need to iterate through each item and add it to the image list...

            $("#image_list_dd").empty();
            $.each(new_img_list, function(k, v) {
                var new_img = `<option id="${v['_id']}" value="${v['_id']}">${v['name']}</option>`;
                //                        console.log(new_img);
                $("#image_list_dd").append(new_img);
            })
            $("#image_list_dd").select2(); //Reinitialize the dynamic search widget
        });
    });

    function load_new_image_set(data_set_name) {
        console.log("I need to be loading this data set now.." + data_set_name);
    }

    // $select.change(function() {
    //      //##This needs to clear as well as update information and change the viewer
    //      //Need to change the image source based on the new image I just added in the toggle, will also push the text
    //      // to a DIV so it's obvious what Image I am looking at
    //      selected_image = this.value;
    //      console.log(image_info_list[this.value].filename_url);

    //      //ALSO ADD IN SOMETHING HERE TO CHANGE THE OVERLAY images
    //      load_new_image(selected_image);

    //  });

    //https://isic-archive.com/api/v1/study/55c442809fc3c1536a012b57/images


    //Need to add in the button actions for the filter clicks

    $("#filter_dialog").dialog({
        autoOpen: false,
        width: 'auto'
    });
    $("#show_magic").click(function() {
        $("#filter_dialog").dialog('open');
        return false;
    });
    $("#filter_dialog").html(color_filter_html);

    //TO DO:  REFACTOR THIS CODE!!! IT SUCKS
    // var $select = $('#image_list_dd');
    // //request the JSON data and parse into the select element
    // //THIS Loads the Image List
    // $.getJSON('data/image_info.json', function(data) {
    //     $("#image_list_dd").empty();
    //     my_data = data.responseJSON;
    //     //iterate over the data and append a select option
    //     $.each(data, function(key, val) {
    //         $("#image_list_dd").append('<option id="' + val.image_name + '">' + val.image_name + '</option>');
    //         image_info_list[val.image_name] = val;
    //     });
    //     //Maybe add functionality here to update_current_image.... this event needs to run when I load stuff which I don't think it is..
    //     var imageName = $("#image_list_dd option:first").val();
    //     update_rater_overlays(imageName);

    //     load_new_image(imageName); //all the code to actually load the initial image I hope should be in here...

    // });

    //Adding a list to identify which rater goes with which color-- probably need a new color scheme at some point
    $.each(raters, function(n, v) {
        //$("#rater_color_list").append(`<li><span style="color:${colours[n]}">${v}</span></li>`);
        $("#rater_color_list").append(
            `<span class="btn btn-default rater_span "><input type='checkbox' class="overlay_toggle" name="${v}" value="${v}" id="show_${v}" class="rater_buttons "><label for="show_${v}" style="color:${colours[n]}">${v}</label></input></span>`);
        //$<input type='checkbox' class="overlay_toggle" name="${v}" value="${v}" id="show_${v}" class="rater_buttons"><label for="show_${v}">${v}</label></input> 
    });
    $(":checkbox").prop('checked', true); //reset all checkboxes to be checked...
    $('.overlay_toggle').click(function() {
        //  console.log(this.id);
        color_some_tiles(this.id, "thefeatureIwanttolookat");
    });

    // Add event handler for changing the image

    //$select.change(function() {
    $("#image_list_dd").change(function() {
        //##This needs to clear as well as update information and change the viewer
        //Need to change the image source based on the new image I just added in the toggle, will also push the text
        // to a DIV so it's obvious what Image I am looking at
        selected_image = this.value;
        //console.log(image_info_list[this.value].filename_url);
        //ALSO ADD IN SOMETHING HERE TO CHANGE THE OVERLAY images
        console.log(this.id, this.value, this.name);

        //I need to debate if I precache this ....
        $.getJSON('https://isic-archive.com/api/v1/image/' + this.value, function(data) {
            cur_image_metadata = data;
            //console.log(cur_image_metadata);
            //Need to pass the image metadata
            load_new_image_from_api(cur_image_metadata)

            //Now load the superpixel data..
            console.log("trying to load superpixel data");

        $.getJSON('api/TileInfo/ALL/' + image_name, function(data) {
                    superpixel_markup_info = data;
                    //I am going to disable buttons on the feature list if that feature isn't present in the currnet image...
                    hide_unannotated_features(superpixel_markup_info);
                    //Also add in something to actual  lly display this..
                    new_mark_superpixels();
                })
        
        }).fail(function() {
            alert('You do not have access to this image...');

            defaultimg_not_avail = {
                'type': 'legacy-image-pyramid',
                levels: [{
                    'url': 'https://c1.staticflickr.com/3/2150/2101058680_64fa63971e.jpg',
                    'height': 435,
                    'width': 356,
                }]
            }
            dg_viewer.open(defaultimg_not_avail);;

        });
      
    });

    $("#tile_toggle").button().click(function() {
        console.log(this.id + 'was pressed')
        $(".tileClass").css('fill', 'none')

    });


    //def getImageDetail(image_id):
    //    """ Get the detailed metadata for an image. """
    //    return apiGet('image/%s' % image_id)
    //https://isic-archive.com/api/v1/%s

    function load_new_image(image_name) {
        //Consolidating all of the function calls that need to be made when I switch an image into this snipper... this should be called
        //on document ready, and attached to the SELECT element when it's changed.

        console.log("consolidinating image load code to here for" + image_name);
        //image_name or maybe image_id.....
        //First remove all of the SVG elements to prevent the screen from flashing weird colors
        $(".tileClass").remove();
        image_filename_url = image_info_list[image_name].filename_url;
        new_tile_source = {
            'type': 'legacy-image-pyramid',
            levels: [{
                'url': image_filename_url,
                'height': image_info_list[image_name].img_height,
                'width': image_info_list[image_name].img_width,
            }]
        }
        update_rater_overlays(image_name);
        dg_viewer.open(new_tile_source);

        //Now that the new image is loaded, should next load the actual markup data for this image
        //I should call this function when I select an image...
        //This gets the markup info for the currently selected image
        $.getJSON('api/TileInfo/ALL/' + image_name, function(data) {
            superpixel_markup_info = data;
            //I am going to disable buttons on the feature list if that feature isn't present in the currnet image...
            hide_unannotated_features(superpixel_markup_info);
            //Also add in something to actual  lly display this..
            new_mark_superpixels();
        })
    }

    function load_new_image_from_api(image_metadata) {
        //The image metadata is pulled from the API

        //image_name or maybe image_id.....
        //First remove all of the SVG elements to prevent the screen from flashing weird colors
        $(".tileClass").remove();


        //IMPORTANT ISSUE HERE.. OSD NEEDS TO BE PATCHED OR I NEED THE BELOW HACK WHICH HARD CODES THE .JPG... it wasn't figuring this out on its own

        base_url = `https://isic-archive.com/api/v1/image/${image_metadata['_id']}/`;
        console.log(base_url);
        image_filename_url = base_url + 'download?contentDisposition=inline&.jpg'
        console.log(image_metadata);

        new_tile_source = {
                'type': 'legacy-image-pyramid',
                levels: [{
                    'url': image_filename_url,
                    'height': image_metadata.meta.acquisition.pixelsY,
                    'width': image_metadata.meta.acquisition.pixelsX,
                }]
            }
            //update_rater_overlays(image_name);  <<TO DOO!!!!
        dg_viewer.open(new_tile_source);
        //http://blog.teamtreehouse.com/learn-asynchronous-image-loading-javascript
        //Now that the new image is loaded, should next load the actual markup data for this image
        //I should call this function when I select an image...
        //This gets the markup info for the currently selected image
        // $.getJSON('api/TileInfo/ALL/' + image_name, function(data) {
        //     superpixel_markup_info = data;
        //     //I am going to disable buttons on the feature list if that feature isn't present in the currnet image...
        //     hide_unannotated_features(superpixel_markup_info);
        //     //Also add in something to actual  lly display this..
        //     new_mark_superpixels();
        // })

    }

    $("#tile_button").click(function() {
        //Make sure tiles are actually visible in case they were toggled off..
        cur_slider_value = OpacitySlider.val();
        $('.tileClass').attr('opacity', cur_slider_value);
        show_all_tiles();
    });

    //Adding RADIO Buttons to allow me to select features
    load_feature_list(); // Deperecetd load feature_list
    show_all_tiles();
    new_mark_superpixels();

    $(function() {
        $('[data-toggle="tooltip"]').tooltip()
    })

    $("#image_list_dd").select2();
    //end of READY function
});


$('#tile_img').toggle();

//$(".rater_span").css('background-color','black')

//https://isic-archive.com/api/v1/image/54cfde22bae47825974ce60c




function update_rater_overlays(imageName) {
    //console.log("NEED TO update the overlay SRC ids as well" + imageName);
    //This will eventually need to reed the list or raters and update the sources for all of the raters that have been added
    //ALSO need to add in something that populates the stats for the rater(s)
    loadSVGTileData(imageName);

    //NEED TO GRAB THE OVERLAY FOR THIS IMAGE
    $(":checkbox").prop('checked', true); //reset all checkboxes to be checked...
    new_mark_superpixels();
}

//COME HERE LATER--- ADD SOME FUNCTION THAT RUNS ON DOCUMENT COMPLETION THAT LOADS THE IMAGE FOR THE VIEWER AND 
//THE PROPER OVERLAY

//need to add a callback function to this as well... hmm so want to load the geodata than push it to the SVG
//<!-- Some tips on working with SVG docs http://stackoverflow.com/questions/3642035/jquerys-append-not-working-with-svg-element
//ttps://www.dashingd3js.com/creating-svg-elements-based-on-data dg_viewer.viewport.maxZoomPixelRatio=5 dg_viewer.viewport.minZoomPixelRatio=0.4 Can play //around with these $(".rater_buttons").click( function() { console.log(this.id) }); -->
</script>
<!-- I should probably have the filter dialog code inject these divs directly -->
<div id="filter_dialog" title="Apply Filters">
    Filter set will appear here
</div>
</body>

</html>
