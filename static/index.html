<!DOCTYPE html5>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>ISIC MultiRater Viewer</title>
    <!-- Bootstrap -->
    <script src="js/jquery-2.1.3.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/jquery-ui.js"></script>
    <script type="text/javascript" src="js/jquery.svg.js"></script>
    <script src="/js/openseadragon.js"></script>
    <script src="/js/openseadragon-svg-overlay.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery.svg.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link href="css/jquery-ui.theme.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">
    <style>
    body {
        border: 5px;
        padding: 10px;
    }
    
    .overlay_img {
        position: absolute;
        // display:block;
        border: 1px solid #666;
        padding: 3px;
        margin-right: 5px;
    }
    </style>
    <script>
    //Putting Various Helper functions up here
    var color20 = d3.scale.category20();

    function random(range) {
        return Math.floor(Math.random() * range);
    }
    var colours = ['purple', 'pink', 'orange', 'yellow', 'lime', 'green', 'blue', 'navy', 'black'];

    var color_heatmap = ['blue','blue','yellow','orange','red'];


    var image_info_list = {};
    var superpixel_markup_info = {}; //Stores the marked up data for each tile and rater
    var active_image = '';
    var current_feature = "net_typ";

    var annotated_feature_list = ['net_typ', 'net_atyp', 'str_chrys'];
    var feature_overlay_basedir = 'images/features_output_dir/';

    var new_geodata;
    var my_data = {};
    </script>
</head>

<body>
    <div class="row">
        <div class="col-md-4">
            <h3>Image List <select id='image_list_dd'></select> </h3>
        </div>
        <div class="col-md-8">
            <span id="tile_toggle">Toggle All Overlays</span>
            <span><button id="tile_button">Show All Superpixels</button></span>
            <script>
            $("input").button();
            </script>
            <span style="border:1px solid black;" id="feature_list_target"></span>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            
            <!-- <div id="toggle_raters_div" style="border:1px;width:400px"> </div>-->
            
            <div class="h4">Overlay Opacity: </div><div id="slider" width="300px !important"></div>
            <span><p>Please select the raters to overlay</p></span>
            <div id="rater_info">
                <div id="tile_opacity"></div>
                <h3>Color Guide:</h3>
                <span id="displayed_data_info" class="h1 lead">
                      <ul id="rater_color_list"></ul>
           </span>
                <div id="feature_info_stats" class="h1 lead"></div>
                <div id="tile_info_stats" class="h1 lead"></div>
            </div>
        </div>
        <div class="col-md-8">
            <div id="openseadragon1" style="width: 800px; height: 600px; border: 1px solid blue" class="openseadragon"></div>
            <script type="text/javascript">
            var dg_viewer = OpenSeadragon({
                id: "openseadragon1",
                prefixUrl: "/images/openseadragon-bin-2.0.0/images/",
                showNavigator: true,
                tileSources: {
                    type: 'legacy-image-pyramid',
                    levels: [{
                        url: 'images/base_img/UDA2_pilot_060-p1c.png',
                        height: 920,
                        width: 960
                    }]
                }
            });

            svg_layer = dg_viewer.svgOverlay(); //need to move to onload handler
            </script>
        </div>
    </div>
    <script>
    //raters = ['Marghoob', 'Braun', 'Rabinowitz', 'Carrera'];
    raters = ['braunr','haroldr','carrerac','marghooa'];

    function new_mark_superpixels(sp_info) {
        $(".tileClass").css('fill', 'none');

        //need to add in the current_feature

        if (superpixel_markup_info[current_feature])  {
                num_superpixels = Object.keys(superpixel_markup_info[current_feature]).length; }
          else {  return; }


       // console.log(num_superpixels)
        $("#tile_info_stats").empty(); /// clear the current DIV before I start putting stats in it..
        $("#tile_info_stats").append(num_superpixels.toString() + ' superpixels are in this image');
        //This code is very sensitive to on load events...
        $.each(superpixel_markup_info[current_feature], function(tileID, rater_data) {
        //         ///I am now iteration over each tile in the selected Image...
                 tileAnnotated = false;
                 raters_for_tile = [];

                //So because of the way we store the data, I need to iterate through each superpixel and determine which rater(s) marked it up.. then color things
                 $.each(rater_data, function(r, v) {
                     if (v != "0.0") {
//                        console.log(r,v,tileID);
                         tileAnnotated = true;
                         raters_for_tile.push(r);
                     }
                 });

                            if (tileAnnotated) {
                     //Now that I know the tile has been annotated, I need to render the results
                     console.log(raters_for_tile, tileID);
                        
                        if (raters_for_tile.length == 1)
                            {
                              //In this case the tile is colored for the individual rater.... otherwise it's a color palette
                            //Currently I am going 
                            //var a = fruits.indexOf("Apple");
                            rater_index = raters.indexOf(raters_for_tile[0])
                            console.log(raters_for_tile,rater_index)

                        $("#tile"+tileID).css('fill',colours[rater_index]);

                            }
                        else{

                        $("#tile"+tileID).css('fill',color_heatmap[raters_for_tile.length]);
                          }

                 }

              });

       
      $(".tileClass").hover(function() {
                console.log(this.id);
                pixnum = (this.id).substring(4);
                $("#tile_info_stats").empty(); /// clear the current DIV before I start putting stats in it..
              $("#tile_info_stats").append(num_superpixels.toString() + ' superpixels are in this image');
              $("#tile_info_stats").append("<br>You are hovering on sp: "+this.id);
              

              tile_num = this.id.substring(4) ; //need to turn the tileID which actually is tile234 or similar into only the number part.. so skip the first 4 chars
              //Determine who marked up this file
              pix_raters = superpixel_markup_info[current_feature][tile_num];
              //remember this may contain ALL raters who assessed this feature, so need to make sure there's not a "0.0" there which means that rater
              //didn't actually mark that specific superpixel with the given feature
              rft = []
              $.each(pix_raters, function(k,v) { if ( v != '0.0') {rft.push(k); } })
              console.log(rft);
              $("#tile_info_stats").append("<br>Raters: "+JSON.stringify(rft));


            });

        };


        function color_some_tiles(rater, feature) {
            //given a feature and a rater and an image ID I should color the respective tiles on the super pixel image
            console.log("should be painting " + feature + "for " + rater);
            new_mark_superpixels(); // loadSVGTileData(imageName);
            //I think I am going to structure this to paint all tiles for all the raters...
        }

        $(document).ready(function() {

          
            var $select = $('#image_list_dd');

            //request the JSON data and parse into the select element
            //THIS Loads the Image List
            $.getJSON('data/image_info.json', function(data) {
                $("#image_list_dd").empty();
                my_data = data.responseJSON;
                //iterate over the data and append a select option
                $.each(data, function(key, val) {
                    $("#image_list_dd").append('<option id="' + val.image_name + '">' + val.image_name + '</option>');
                    image_info_list[val.image_name] = val;
                });
                //Maybe add functionality here to update_current_image.... this event needs to run when I load stuff which I don't think it is..

            });

            //Adding a list to identify which rater goes with which color-- probably need a new color scheme at some point
            $.each(raters, function(n, v) {
                //$("#rater_color_list").append(`<li><span style="color:${colours[n]}">${v}</span></li>`);
                $("#rater_color_list").append(
                    `<input type='checkbox' class="overlay_toggle" name="${v}" value="${v}" id="show_${v}" class="rater_buttons "><label for="show_${v}" style="color:${colours[n]}">${v}</label></input><br>`);
                //$<input type='checkbox' class="overlay_toggle" name="${v}" value="${v}" id="show_${v}" class="rater_buttons"><label for="show_${v}">${v}</label></input> 
            });
            $(":checkbox").prop('checked', true); //reset all checkboxes to be checked...
             $('.overlay_toggle').click(function() {
                //  console.log(this.id);
                //So I need to check the state of the button to either draw or clear a given tile(s) colors for a rater..
                color_some_tiles(this.id, "thefeatureIwanttolookat");
            });

            // Add event handler for changing the image
            $select.change(function() {
                //##This needs to clear as well as update information and change the viewer
                //Need to change the image source based on the new image I just added in the toggle, will also push the text
                // to a DIV so it's obvious what Image I am looking at
                $selected_image = this.value;
                console.log(image_info_list[this.value].filename_url);
                selected_image_filename_url = image_info_list[this.value].filename_url;
                //ALSO ADD IN SOMETHING HERE TO CHANGE THE OVERLAY images
                new_tile_source = {
                    'type': 'legacy-image-pyramid',
                    levels: [{
                        'url': selected_image_filename_url,
                        'height': image_info_list[this.value].img_height,
                        'width': image_info_list[this.value].img_width,
                    }]
                }
                update_rater_overlays($selected_image);
                dg_viewer.open(new_tile_source);

                //Now that the new image is loaded, should next load the actual markup data for this image
                //I should call this function when I select an image...

                //Need to refactor this.... ill be calling this too often
                $.getJSON('api/TileInfo/ALL/' + $selected_image , function(data) {
                    superpixel_markup_info = data;
                })

            });

            $("#tile_toggle").button().click(function() {
                console.log(this.id + 'was pressed')
                $(".tileClass").css('fill', 'none')
            });

            $("#slider").slider({
                range: false,
                max: 1,
                min: 0,
                value: 0.8,
                step: 0.05,
                change: function(event, ui) {
                    cur_slider_value = $(this).slider("option", "value");
                    console.log(cur_slider_value);
                    $(".tileClass").attr('opacity', cur_slider_value);
                }
            });

            $("#tile_button").button();
            $("#tile_button").click(function() {show_all_tiles();          });

            //Adding RADIO Buttons to allow me to select features

            flt = $("#feature_list_target");
            $.each(annotated_feature_list, function(v, k) {
                //console.log('adding radio buttons');
                var rb = '<input type="radio" name=rb_feature_set id="feat_' + k + '" value="' + k + '" /><label for="feat_' + k + '">' + k + '<label>'
                var radioBtn = $(rb);
                flt.append(radioBtn);
            });
            //now that the buttons are apended I can turn it into a button set
            flt.buttonset();
            //Now add an onclick handler for this..
            $('#feature_list_target input[type=radio]').change(function() {
                console.log(this.value);
                current_feature = this.value;

                $("#feature_info_stats").empty();
                //ALSO ADDI N SOME STATS TO INDICATE HOW MANY TILES WERE MARKED FOR THIS FEATURE...
                cfd = superpixel_markup_info[current_feature]; //Current Feature data
                if ( ! cfd) { $("#feature_info_stats").append("NO EXAMPLES FOR  feature"+current_feature);  }
                else {

                      $("#feature_info_stats").append("SOME EXAMPLES  feature"+current_feature); 

                      }

                new_mark_superpixels();

            })
        });


        $('#tile_img').toggle();

        function update_rater_overlays(imageName) {
            console.log("NEED TO update the overlay SRC ids as well" + imageName);
            //This will eventually need to reed the list or raters and update the sources for all of the raters that have been added
            //ALSO need to add in something that populates the stats for the rater(s)
            loadSVGTileData(imageName);

            //NEED TO GRAB THE OVERLAY FOR THIS IMAGE
            $(":checkbox").prop('checked', true); //reset all checkboxes to be checked...

        }
        //ADDING A CLASS HANDLER FOR ALL OVERLAYS SO THEY ARE HIDDEN IF IT CAN'T FIND THE IMAGE
        $(".overlay_img").error(function() {
            $(this).hide();
        });



        //COME HERE LATER--- ADD SOME FUNCTION THAT RUNS ON DOCUMENT COMPLETION THAT LOADS THE IMAGE FOR THE VIEWER AND 
        //THE PROPER OVERLAY

        $(function() {
            //Adding keyboard listnered to toggle the tiles on/off if I press the letter t (for toggle)
            $("body").keypress(function(event) {
                if (event.keyCode == 116) {
                    cur_opacity = $('.tileClass').attr('opacity');
                    cur_slider_value = $("#slider").slider("option", "value");
                    var new_opacity = (cur_opacity == 0) ? cur_slider_value : 0;
                    $('.tileClass').attr('opacity', new_opacity);
                }
            });
        });


        //need to add a callback function to this as well... hmm so want to load the geodata than push it to the SVG

        function contourdata_to_shape(contours, img_width) {
            scale_factor = 1;
            polygon_list = [];

            //Openseadragon uses the image width for bo the x and y scale factor... probably should rename this pixel factor
            x_scale_factor = 1.0 / img_width;
            y_scale_factor = 1.0 / img_width;

            $.each(contours, function(index, contour) {
                coord_info = contour.geometry.coordinates;

                coord_string = "";
                $.each(coord_info, function(k, v) {
                        coord_string += `${(v[0]* x_scale_factor ) },${ ( v[1] * y_scale_factor) } `;
                    }) // the |0 made them all integers

                polygon_svg_str = `<polygon points="${coord_string}" style="fill:${colours[ random(9)]};stroke;purple;stroke-width:1;opacity:0.5" id="tile${contour.properties.labelindex}" class="tileClass" />`;
                labelindex = contour.properties.labelindex;

                polygon_list.push({
                    'coords': coord_string,
                    'labelindex': contour.properties.labelindex
                });
            });

            //Need to add the below function to a callback function for above..
            $(".tileClass").hover(function() {
                console.log(this.id)
            });

            return polygon_list;

        }

        //<!-- Some tips on working with SVG docs http://stackoverflow.com/questions/3642035/jquerys-append-not-working-with-svg-element


        //ttps://www.dashingd3js.com/creating-svg-elements-based-on-data dg_viewer.viewport.maxZoomPixelRatio=5 dg_viewer.viewport.minZoomPixelRatio=0.4 Can play //around with these $(".rater_buttons").click( function() { console.log(this.id) }); -->
        function loadSVGTileData(imageName) {

            console.log('need to load svg data for' + imageName);
            SVG_file = image_info_list[imageName].superpixel_svg;
            img_height = image_info_list[imageName].img_height;
            img_width = image_info_list[imageName].img_width;

            new_geodata = function() {
                console.log('loading new geo data');
                geo_array = [];
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': SVG_file,
                    'dataType': "json",
                    'success': function(result) {
                        $.each(result, function(i, contour) {
                            geo_array.push(JSON.parse(contour))
                        });
                        //GEO ARRAY IS NOW generated with contours... so can call another function to generate an SVG layer a well // 
                    }
                });

                return geo_array;
            }();
            

            //  This will iterate through all the tiles and color them a different color to show the tile overlays
            $(".tileClass").remove();
           
            my_points = contourdata_to_shape(new_geodata, img_width);

            //This generates the pretty multicolor tile image
            $.each(my_points, function(k, point_list) {
                d3.select(svg_layer.node()).append("polygon").attr("points", point_list.coords).style('fill', 'none').attr('opacity', 0.5).attr('class', 'tileClass').attr('id', 'tile' + point_list.labelindex)
            });


        }

        function update_tile_stats() {
            //This gets called when I select a new feature or image and displays information about the number of tiles that have the feature


        }

        function show_all_tiles() {
              //This will iterate through all the tiles and color them a different color to show the tile overlays
              //s$(".tileClass").remove()
              $(".tileClass").css( 'fill', function() { pixnum = this.id.substring(4); console.log( pixnum ); return color20( (pixnum %20 ))  } ); 
              }


    </script>
</body>

</html>
