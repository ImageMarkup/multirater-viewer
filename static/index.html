<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>ISIC MultiRater Viewer</title>
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="css/bootstrap-slider.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link href="css/jquery-ui.theme.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet">

    
    <script src="js/multirater.js"></script>
    <script src="js/jquery-2.1.3.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/bootstrap-slider.js"></script>
    <!-- <script src="js/jquery.svg.js"></script> -->
    <script src="js/openseadragon.js"></script>
    <script src="js/openseadragon-svg-overlay.js"></script>
    <style>
    .right-side-button {
        float: right;
        padding-right: 20px;
        margin-right: 20px;
    }
    
    .panel-heading a:after {
        font-family: 'Glyphicons Halflings';
        content: "\e114";
        float: right;
        color: grey;
    }
    
    .panel-heading a.collapsed:after {
        content: "\e080";
    }
    /* Overriding radio buttons so I can add some space and curve the borders */
    
    .feature_btns {
        /*border-top-right-radius: 4px !important;
    border-bottom-right-radius: 4px !important  ;*/
        border-radius: 4px !important;
        margin: 2px !important;
        padding: 2px !important;
    }
    
    .btn-group-single > .btn:first-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    
    .navbar-brand {
        color: yellow !important;
    }
    /*  .navbar-brand {
        position: absolute;
        width: 100%;
        left: 0;
        text-align: left;
        margin: auto;
    }*/
    
    .slider-selection {
        background: #BABABA;
    }
    
    #opacity_slider .slider-selection {
        background: #BABABA;
    }
    
    .rtr {
        padding: 10px;
        margin: 10px;
    }
    
    .featurebtns-example {
        margin: 2px !important;
        margin-bottom: 2px !important;
        padding: 2px !important;
    }
    
    .button-panel {
        margin: 2px !important;
        margin-bottom: 2px !important;
        padding: 2px !important;
    }
    </style>
</head>

<body>
    <!-- begin template -->
    <nav class="navbar navbar-custom navbar-fixed-top " role="navigation">
        <div class="navbar navbar-fixed-top navbar-left   ">
            <a class="navbar-brand" href="#">ISIC MultiRater Viewer</a>
        </div>
        <div class="navbar-right navbar navbar-fixed-top right-side-button ">
            <span class="navbar-right right-side-button navbar-btn btn-sm">Overlay Opacity: <input id="opacity_slider" data-slider-id='op_slider' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.05" data-slider-value="0.5"/></span>
            <button id="tile_toggle" class="btn btn-default navbar-right navbar-btn btn-sm ">Hide Overlays</button>
            <button id="tile_button" class="btn  btn-default navbar-right  navbar-btn btn-sm ">Show superpixels</button>
        </div>
    </nav>

    <div class="container-fluid" id="main">


        <div class="row">
            <div class="col-xs-4" id="left">
                <h3>Image List <select id='image_list_dd'></select> </h3>
                <!-- item list -->
                <div class="panel panel-default">
                </div>
                <!-- <div id="slider" width="300px !important"></div> -->


                <div class="panel panel-default">
                      <ul id="rater_color_list"></ul>

                    <div id="rater_info">
                        <span id="displayed_data_info" class="h6"></span>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div id="feature_btn_group" class="featurebtns_wrapper" data-toggle="buttons-radio"></div>
                </div>
            </div>
            <div class="col-xs-8">
                <div id="openseadragon1" style="width: 100%; height: 600px; border: 1px solid blue" class="openseadragon"></div>
            </div>
        </div>

		<div  style="display: none;">
                <div id="feature_info_stats" class="col-xs-4"></div>
                <div id="tile_info_stats" class="col-xs-4"></div>
                <div id="rater_info_stats" class="col-xs-4"></div>
                        <div id="tile_opacity" style="display:none"></div>

			</div>

</body>

</html>
<script>
//Putting Various Helper functions up here
var color20 = d3.scale.category20();


var colours = ['purple', 'blue', 'green  ', 'navy', 'green', 'navy', 'blue', 'pink', 'orange', 'yellow', 'lime', 'green', 'blue', 'navy', 'black'];

var color_heatmap = ['blue', 'blue', 'yellow', 'orange', 'red'];

var image_info_list = {};
var superpixel_markup_info = {}; //Stores the marked up data for each tile and rater
var active_image = '';
var current_feature = "net_typ";

var annotated_feature_list = [];
//['net_typ', 'net_atyp', 'str_chrys','net_targ','ves_serp','ves_clods']; //will load these frim a file

var feature_groups = [{
    'feature_group': 'Structures',
    'feature_abbrev': 'str'
}, {
    'feature_group': 'Colors',
    'feature_abbrev': 'c'
}, {
    'feature_group': 'Vessels',
    'feature_abbrev': 'ves'
}, {
    'feature_group': 'Other',
    'feature_abbrev': 'oth'
}, {
    'feature_group': 'Network',
    'feature_abbrev': 'net'
}]

// $.each(top_level_features, function(k, v) {
//         feat = top_level_features[k];
//         console.log(feat.feature_group, feat.feature_abbrev)
//     }
    //For each high level feature group, I want to now list all of the features associated with that group

//);


var new_geodata;
var my_data = {};
</script>
<script type="text/javascript">


var dg_viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "/images/openseadragon-bin-2.0.0/images/",
    showNavigator: true,
});

svg_layer = dg_viewer.svgOverlay(); //need to move to onload handler

raters = ['braunr', 'haroldr', 'carrerac', 'marghooa'];

var OpacitySlider;

$(document).ready(function() {

    //Opacity slides which is at the top of the toolbar for  changing opacity..
    OpacitySlider = $('#opacity_slider').bootstrapSlider({
        formatter: function(value) {
            return 'Current value: ' + value;
        }
    });

    OpacitySlider.change(function(val) {
        new_slider_value = val.value.newValue;
      //  console.log('new slider value is' + new_slider_value)
        $(".tileClass").attr('opacity', new_slider_value);

    });

    var $select = $('#image_list_dd');

    //THIS Loads the Image List
    $.getJSON('data/image_info.json', function(data) {
        $("#image_list_dd").empty();
        my_data = data.responseJSON;
        //iterate over the data and append a select option
        $.each(data, function(key, val) {
            $("#image_list_dd").append('<option id="' + val.image_name + '">' + val.image_name + '</option>');
            image_info_list[val.image_name] = val;
        });
        //Maybe add functionality here to update_current_image.... this event needs to run when I load stuff which I don't think it is..
        var imageName = $("#image_list_dd option:first").val();
        update_rater_overlays(imageName);

        load_new_image(imageName); //all the code to actually load the initial image I hope should be in here...

    });

    //Adding a list to identify which rater goes with which color-- probably need a new color scheme at some point
    $.each(raters, function(n, v) {
        //$("#rater_color_list").append(`<li><span style="color:${colours[n]}">${v}</span></li>`);
        $("#rater_color_list").append(
            `<span class="btn btn-default "><label for="show_${v}" style="color:${colours[n]}">${v}</label></span>`);
    });
    $(":checkbox").prop('checked', true); //reset all checkboxes to be checked...
    $('.overlay_toggle').click(function() {
        //  console.log(this.id);
        color_some_tiles(this.id, "thefeatureIwanttolookat");
    });

    // Add event handler for changing the image
    $select.change(function() {
        //##This needs to clear as well as update information and change the viewer
        //Need to change the image source based on the new image I just added in the toggle, will also push the text
        // to a DIV so it's obvious what Image I am looking at
        selected_image = this.value;
        //console.log(image_info_list[this.value].filename_url);

        load_new_image(selected_image);

    });

    $("#tile_toggle").button().click(function() {
       // console.log(this.id + 'was pressed')
        $(".tileClass").css('fill', 'none')
    });


    function load_new_image(image_name) {
        //Consolidating all of the function calls that need to be made when I switch an image into this snipper... this should be called
        //on document ready, and attached to the SELECT element when it's changed.

      //  console.log("consolidinating image load code to here for" + image_name);

        //First remove all of the SVG elements to prevent the screen from flashing weird colors
        $(".tileClass").remove();

        image_filename_url = image_info_list[image_name].filename_url;
        new_tile_source = {
            'type': 'legacy-image-pyramid',
            levels: [{
                'url': image_filename_url,
                'height': image_info_list[image_name].img_height,
                'width': image_info_list[image_name].img_width,
            }]
        }
        update_rater_overlays(image_name);
        dg_viewer.open(new_tile_source);

        //Now that the new image is loaded, should next load the actual markup data for this image
        //I should call this function when I select an image...
        //This gets the markup info for the currently selected image
        $.getJSON('api/TileInfo/ALL/' + image_name, function(data) {
            superpixel_markup_info = data;
            //I am going to disable buttons on the feature list if that feature isn't present in the currnet image...
            hide_unannotated_features(superpixel_markup_info);
            //Also add in something to actual  lly display this..
            new_mark_superpixels();
        })

    }


    $("#tile_button").click(function() {
        //Make sure tiles are actually visible in case they were toggled off..
        cur_slider_value = OpacitySlider.val();
        $('.tileClass').attr('opacity', cur_slider_value);
        show_all_tiles();
    });

    //Adding RADIO Buttons to allow me to select features
    load_feature_list();
    show_all_tiles();
    new_mark_superpixels();

    $(function() {
        $('[data-toggle="tooltip"]').tooltip()
    })
    //end of READY function
});


$('#tile_img').toggle();





function hide_unannotated_features(superpixel_markup_info) {
//    console.log('should be hiding buttons');
    //Beacause we may have 30-50 features present, we do not want the observer to try and click on each button to "see" if a given feature is there
    //First I need to reset all the radio buttons to make them all clickable, then disable if not present
    //avail_features list the features that have been detected in this image..
    img_avail_features = Object.keys(superpixel_markup_info);
    //var annotated_feature_list = ['net_typ', 'net_atyp', 'str_chrys','net_targ','ves_serp','ves_clods']; //will load these frim a file

    //TODO Need to clean up logic below; for some reason if I reset all the buttons above and then ran the below code, nothing got set
    //Not sure if I was running into a race condition?
    $.each(annotated_feature_list, function(index, value) {
      //  console.log(index, value);
        if (img_avail_features.indexOf(value) < 0) { //feature is not present
            //the ID of the feature buttons actually have feat_ prepended to the feature name..
            $("#feat_" + value).addClass('disabled');
           // console.log('I think I just this?? #feat_' + value);
            // $("#feat_net_targ").addClass('disabled');
          
        } else if (img_avail_features.indexOf(value) > -1) {
            $("#feat_" + value).removeClass('disabled');
        }
    });
}



//COME HERE LATER--- ADD SOME FUNCTION THAT RUNS ON DOCUMENT COMPLETION THAT LOADS THE IMAGE FOR THE VIEWER AND 
//THE PROPER OVERLAY

$(function() {
    //Adding keyboard listnered to toggle the tiles on/off if I press the letter t (for toggle)
    $("body").keypress(function(event) {
        if (event.keyCode == 116) {
            cur_opacity = $('.tileClass').attr('opacity');
            cur_slider_value = OpacitySlider.val();
            var new_opacity = (cur_opacity == 0) ? cur_slider_value : 0;
            $('.tileClass').attr('opacity', new_opacity);
        }
    });
});


//This code will cgenerate the buttons
function run_it() {
    $("#feature_btn_group").empty(); //clear current selection
    // $.each(top_level_features, function(k, v) {
    //         feat = top_level_features[k];
    //     }
    // );
}
</script>
